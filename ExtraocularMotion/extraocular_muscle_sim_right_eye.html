<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Extraocular Muscle Simulator – Right Eye</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #0f172a;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      padding: 0;
    }

    .app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: center;
      padding: 16px;
      box-sizing: border-box;
    }

    .header {
      text-align: center;
      margin-bottom: 12px;
    }

    .header h1 {
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: 0.04em;
    }

    .header p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: #9ca3af;
    }

    .main {
      display: flex;
      gap: 16px;
      align-items: stretch;
      justify-content: center;
      flex-wrap: wrap;
    }

    .eye-panel {
      background: radial-gradient(circle at 20% 20%, #1f2937, #020617);
      border-radius: 18px;
      padding: 16px;
      position: relative;
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      flex: 0 1 420px;
    }

    .eye-wrapper {
      position: relative;
      width: 360px;
      height: 360px;
      margin: 0 auto;
    }

    #vectorCanvas {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .eye-circle {
      position: absolute;
      inset: 30px;
      margin: auto;
      width: 300px;
      height: 300px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffffff, #e5e7eb);
      box-shadow:
        0 0 0 6px rgba(15,23,42,0.8),
        0 20px 35px rgba(0,0,0,0.8);
      overflow: hidden;
    }

    .corneal-highlight {
      position: absolute;
      top: 26%;
      left: 22%;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,0.8), transparent 70%);
      pointer-events: none;
      opacity: 0.85;
      filter: blur(1px);
    }

    #iris {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 150px;
      height: 150px;
      margin: -75px 0 0 -75px;
      border-radius: 50%;
      background:
        radial-gradient(circle at 30% 30%, #93c5fd, #1d4ed8 55%, #020617 75%),
        repeating-conic-gradient(from 0deg,
          rgba(147,197,253,0.15) 0deg 8deg,
          rgba(30,64,175,0.75) 8deg 16deg);
      box-shadow:
        inset 0 0 18px rgba(15,23,42,0.8),
        0 0 8px rgba(37,99,235,0.8);
      transform-origin: center center;
      transition: transform 0.07s linear;
    }

    #pupil {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 54px;
      height: 54px;
      margin: -27px 0 0 -27px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #111827, #020617 70%);
      box-shadow:
        0 0 16px rgba(0,0,0,0.9),
        0 0 3px rgba(0,0,0,0.8);
    }

    .axes-labels {
      position: absolute;
      inset: 0;
      pointer-events: none;
      font-size: 0.7rem;
      color: #9ca3af;
      text-shadow: 0 0 4px rgba(0,0,0,0.8);
    }

    .axes-labels .up    { position: absolute; top: 8px; left: 50%; transform: translateX(-50%); }
    .axes-labels .down  { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); }
    .axes-labels .left  { position: absolute; top: 50%; left: 8px; transform: translateY(-50%); }
    .axes-labels .right { position: absolute; top: 50%; right: 8px; transform: translateY(-50%); }

    .eye-footer {
      margin-top: 10px;
      font-size: 0.8rem;
      color: #9ca3af;
      text-align: center;
    }

    .gaze-readout {
      font-weight: 600;
      color: #fbbf24;
    }

    .controls {
      flex: 0 1 420px;
      background: radial-gradient(circle at 80% 0%, #1f2937, #020617);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 620px;
      overflow-y: auto;
    }

    .controls h2 {
      margin: 0;
      font-size: 1.1rem;
    }

    .controls p {
      margin: 2px 0 8px;
      font-size: 0.85rem;
      color: #9ca3af;
    }

    .slider-group {
      margin-bottom: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(55,65,81,0.8);
    }

    .slider-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
      font-size: 0.85rem;
    }

    .muscle-name {
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .muscle-name .side-tag {
      font-size: 0.7rem;
      font-weight: 500;
      color: #9ca3af;
      text-transform: uppercase;
      margin-left: 4px;
    }

    .slider-value {
      font-feature-settings: "tnum" 1, "lnum" 1;
      color: #e5e7eb;
      min-width: 32px;
      text-align: right;
      font-size: 0.8rem;
    }

    .slider-subtext {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    input[type="range"] {
      width: 100%;
      appearance: none;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #eab308, #ef4444);
      outline: none;
      margin: 4px 0 0;
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #e5e7eb;
      border: 2px solid #0f172a;
      box-shadow: 0 0 0 3px rgba(248,250,252,0.25);
      cursor: pointer;
    }

    input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #e5e7eb;
      border: 2px solid #0f172a;
      box-shadow: 0 0 0 3px rgba(248,250,252,0.25);
      cursor: pointer;
    }

    input[type="range"]::-moz-range-track {
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(90deg, #22c55e, #eab308, #ef4444);
    }

    .buttons-row {
      display: flex;
      gap: 8px;
      justify-content: flex-start;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    button {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.6);
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease, border-color 0.08s ease;
    }

    button span.icon {
      font-size: 0.9rem;
    }

    button:hover {
      transform: translateY(-1px);
      background: rgba(15,23,42,1);
      border-color: #9ca3af;
      box-shadow: 0 12px 22px rgba(0,0,0,0.75);
    }

    button:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 6px 12px rgba(0,0,0,0.8);
    }

    .legend {
      margin-top: 4px;
      font-size: 0.75rem;
      color: #9ca3af;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 4px 12px;
    }

    .legend-item {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #93c5fd;
      box-shadow: 0 0 6px rgba(59,130,246,0.8);
    }

    .legend-label {
      font-size: 0.72rem;
    }

    @media (max-width: 900px) {
      .eye-wrapper {
        width: 300px;
        height: 300px;
      }

      .eye-circle {
        inset: 30px;
        width: 240px;
        height: 240px;
      }

      #iris {
        width: 120px;
        height: 120px;
        margin: -60px 0 0 -60px;
      }

      #pupil {
        width: 44px;
        height: 44px;
        margin: -22px 0 0 -22px;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>Extraocular Muscle Simulator – Right Eye</h1>
    <p>
      Drag the muscle sliders to change activation. Balanced sliders (~50) represent primary gaze;
      deviations simulate paresis or overactivity.
    </p>
  </div>

  <div class="main">
    <!-- Eye panel -->
    <section class="eye-panel" aria-label="Right eye visualization">
      <div class="eye-wrapper">
        <!-- Vector overlay -->
        <svg id="vectorCanvas" viewBox="0 0 360 360">
          <defs>
            <marker id="arrowHead" markerWidth="8" markerHeight="8" refX="4" refY="4"
                    orient="auto" markerUnits="strokeWidth">
              <path d="M0,0 L8,4 L0,8 z" fill="#fbbf24"/>
            </marker>
          </defs>
          <!-- Neutral crosshair -->
          <line x1="180" y1="40" x2="180" y2="320"
                stroke="rgba(75,85,99,0.7)" stroke-width="1.2" stroke-dasharray="4 4"/>
          <line x1="40" y1="180" x2="320" y2="180"
                stroke="rgba(75,85,99,0.7)" stroke-width="1.2" stroke-dasharray="4 4"/>
          <!-- Net gaze vector (updated in JS) -->
          <line id="netVector" x1="180" y1="180" x2="180" y2="180"
                stroke="#fbbf24" stroke-width="3"
                marker-end="url(#arrowHead)" opacity="0.0"/>
        </svg>

        <div class="eye-circle">
          <div class="corneal-highlight"></div>
          <div id="iris">
            <div id="pupil"></div>
          </div>
        </div>

        <div class="axes-labels">
          <div class="up">Up (elevation)</div>
          <div class="down">Down (depression)</div>
          <div class="left">Left (adduction)</div>
          <div class="right">Right (abduction)</div>
        </div>
      </div>

      <div class="eye-footer">
        Net gaze: <span class="gaze-readout" id="gazeReadout">Primary position</span>
      </div>
    </section>

    <!-- Controls -->
    <section class="controls" aria-label="Extraocular muscle controls">
      <h2>Muscle activation meters</h2>
      <p>
        Each slider is an activation meter for one extraocular muscle of the right eye.
        Values below 50 simulate weakness; values above 50 simulate overactivity.
      </p>

      <!-- Recti -->
      <div class="slider-group">
        <div class="slider-header">
          <div class="muscle-name">
            Medial rectus <span class="side-tag">(adduction)</span>
          </div>
          <div class="slider-value" id="mrVal">50</div>
        </div>
        <input id="mr" type="range" min="0" max="100" value="50" />
        <div class="slider-subtext">Pulls the right eye toward the nose (adduction).</div>
      </div>

      <div class="slider-group">
        <div class="slider-header">
          <div class="muscle-name">
            Lateral rectus <span class="side-tag">(abduction)</span>
          </div>
          <div class="slider-value" id="lrVal">50</div>
        </div>
        <input id="lr" type="range" min="0" max="100" value="50" />
        <div class="slider-subtext">Pulls the right eye toward the temple (abduction).</div>
      </div>

      <div class="slider-group">
        <div class="slider-header">
          <div class="muscle-name">
            Superior rectus <span class="side-tag">(elevates + adducts)</span>
          </div>
          <div class="slider-value" id="srVal">50</div>
        </div>
        <input id="sr" type="range" min="0" max="100" value="50" />
        <div class="slider-subtext">
          Primary action: elevation. Secondary: adduction and intorsion.
        </div>
      </div>

      <div class="slider-group">
        <div class="slider-header">
          <div class="muscle-name">
            Inferior rectus <span class="side-tag">(depresses + adducts)</span>
          </div>
          <div class="slider-value" id="irVal">50</div>
        </div>
        <input id="ir" type="range" min="0" max="100" value="50" />
        <div class="slider-subtext">
          Primary action: depression. Secondary: adduction and extorsion.
        </div>
      </div>

      <!-- Obliques -->
      <div class="slider-group">
        <div class="slider-header">
          <div class="muscle-name">
            Superior oblique <span class="side-tag">(depresses + abducts)</span>
          </div>
          <div class="slider-value" id="soVal">50</div>
        </div>
        <input id="so" type="range" min="0" max="100" value="50" />
        <div class="slider-subtext">
          Primary action: intorsion. Important secondary action: depression in adducted gaze, plus abduction.
        </div>
      </div>

      <div class="slider-group">
        <div class="slider-header">
          <div class="muscle-name">
            Inferior oblique <span class="side-tag">(elevates + abducts)</span>
          </div>
          <div class="slider-value" id="ioVal">50</div>
        </div>
        <input id="io" type="range" min="0" max="100" value="50" />
        <div class="slider-subtext">
          Primary action: extorsion. Important secondary action: elevation in adducted gaze, plus abduction.
        </div>
      </div>

      <div class="buttons-row">
        <button id="resetBtn" type="button">
          <span class="icon">↺</span>
          Reset to primary gaze
        </button>
        <button id="cardinalBtn" type="button">
          <span class="icon">✚</span>
          Step through cardinal gazes
        </button>
      </div>

      <div class="legend">
        <div class="legend-item">
          <div class="legend-swatch"></div>
          <div class="legend-label">
            Yellow arrow: net pull on the globe from the current activation pattern.
          </div>
        </div>
        <div class="legend-item">
          <div class="legend-swatch" style="background:#22c55e; box-shadow:0 0 6px rgba(34,197,94,0.8);"></div>
          <div class="legend-label">
            0–50: relative weakness compared with primary gaze tone.
          </div>
        </div>
        <div class="legend-item">
          <div class="legend-swatch" style="background:#ef4444; box-shadow:0 0 6px rgba(239,68,68,0.8);"></div>
          <div class="legend-label">
            50–100: relative overactivity compared with primary gaze tone.
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
  // Simple biomechanical model:
  // We treat 50 on each slider as "baseline tone" that yields primary gaze (0,0).
  // For each muscle, we assign a 2D vector [horizontal, vertical] in patient space:
  //   horizontal: + = abduction (temporal, on-screen right), - = adduction (nasal, on-screen left)
  //   vertical:   + = elevation (up), - = depression (down)
  // The net gaze vector is the sum over muscles of (activationDelta * muscleVector).

  const muscles = {
    mr: { label: "Medial rectus",  horiz: -1.0,  vert:  0.0, valueSpanId: "mrVal" },
    lr: { label: "Lateral rectus", horiz:  1.0,  vert:  0.0, valueSpanId: "lrVal" },
    sr: { label: "Superior rectus",horiz: -0.3, vert:  1.0, valueSpanId: "srVal" },
    ir: { label: "Inferior rectus",horiz: -0.3, vert: -1.0, valueSpanId: "irVal" },
    so: { label: "Superior oblique",horiz:  0.3, vert: -0.7, valueSpanId: "soVal" },
    io: { label: "Inferior oblique",horiz:  0.3, vert:  0.7, valueSpanId: "ioVal" }
  };

  const iris = document.getElementById("iris");
  const netVectorLine = document.getElementById("netVector");
  const gazeReadout = document.getElementById("gazeReadout");
  const resetBtn = document.getElementById("resetBtn");
  const cardinalBtn = document.getElementById("cardinalBtn");

  const sliders = {};
  Object.keys(muscles).forEach(key => {
    sliders[key] = document.getElementById(key);
  });

  function updateFromSliders() {
    let netH = 0;
    let netV = 0;

    // Update numeric labels and compute net vector
    for (const key of Object.keys(muscles)) {
      const slider = sliders[key];
      const muscle = muscles[key];
      const rawVal = Number(slider.value); // 0..100
      const delta = (rawVal - 50) / 50;    // -1..1
      document.getElementById(muscle.valueSpanId).textContent = rawVal.toString();

      netH += delta * muscle.horiz;
      netV += delta * muscle.vert;
    }

    // Clamp magnitude for visualization
    const maxMag = 1.8;
    const mag = Math.sqrt(netH * netH + netV * netV) || 0;
    let h = netH;
    let v = netV;
    if (mag > maxMag && mag > 0) {
      const scale = maxMag / mag;
      h *= scale;
      v *= scale;
    }

    // Move iris (eye) within sclera
    const maxOffset = 50; // pixels
    const offsetX = h * maxOffset;
    const offsetY = -v * maxOffset; // canvas y-axis is inverted relative to clinical up/down

    iris.style.transform = "translate(" + offsetX.toFixed(1) + "px, " + offsetY.toFixed(1) + "px)";

    // Update vector arrow
    const centerX = 180;
    const centerY = 180;
    const arrowScale = 70;
    const endX = centerX + h * arrowScale;
    const endY = centerY - v * arrowScale;

    if (mag < 0.03) {
      netVectorLine.setAttribute("opacity", "0.0");
    } else {
      netVectorLine.setAttribute("opacity", "1.0");
      netVectorLine.setAttribute("x1", centerX);
      netVectorLine.setAttribute("y1", centerY);
      netVectorLine.setAttribute("x2", endX);
      netVectorLine.setAttribute("y2", endY);
    }

    // Update textual description
    gazeReadout.textContent = describeGaze(h, v);
  }

  function describeGaze(h, v) {
    const mag = Math.sqrt(h*h + v*v);
    if (mag < 0.05) {
      return "Primary position (balanced pull)";
    }

    const dirH = h > 0.12 ? "right (abduction)" : (h < -0.12 ? "left (adduction)" : "");
    const dirV = v > 0.12 ? "up (elevation)" : (v < -0.12 ? "down (depression)" : "");

    let text = "";
    if (dirV && dirH) {
      text = dirV + " and " + dirH;
    } else if (dirV) {
      text = dirV;
    } else if (dirH) {
      text = dirH;
    } else {
      text = "Near primary position";
    }

    // Simple note about dominant muscles
    const dominant = findDominantMuscles();
    if (dominant.length > 0) {
      text += " – dominant pull from " + dominant.join(", ");
    }
    return text;
  }

  function findDominantMuscles() {
    // Muscles with |delta| >= 0.6 are considered dominant
    const dominant = [];
    for (const key of Object.keys(muscles)) {
      const slider = sliders[key];
      const val = Number(slider.value);
      const delta = Math.abs((val - 50) / 50);
      if (delta >= 0.6) {
        dominant.push(muscles[key].label);
      }
    }
    return dominant;
  }

  // Reset all sliders
  resetBtn.addEventListener("click", () => {
    for (const key of Object.keys(muscles)) {
      sliders[key].value = "50";
    }
    updateFromSliders();
  });

  // Step through cardinal gazes by temporarily setting a pattern
  const cardinalPatterns = [
    { name: "Primary position", values: { mr:50, lr:50, sr:50, ir:50, so:50, io:50 } },
    // Right (abduction) – LR and obliques
    { name: "Right gaze (abduction)", values: { mr:30, lr:80, sr:45, ir:45, so:60, io:60 } },
    // Left (adduction) – MR and vertical recti
    { name: "Left gaze (adduction)", values: { mr:80, lr:30, sr:60, ir:60, so:40, io:40 } },
    // Up & right
    { name: "Up-right (SR + IO)", values: { mr:40, lr:75, sr:80, ir:30, so:40, io:80 } },
    // Up & left
    { name: "Up-left (SR + IO in adduction)", values: { mr:75, lr:35, sr:80, ir:30, so:35, io:75 } },
    // Down & right
    { name: "Down-right (IR + SO)", values: { mr:40, lr:75, sr:30, ir:80, so:80, io:30 } },
    // Down & left
    { name: "Down-left (IR + SO in adduction)", values: { mr:75, lr:35, sr:30, ir:80, so:80, io:30 } }
  ];
  let cardinalIndex = 0;

  cardinalBtn.addEventListener("click", () => {
    cardinalIndex = (cardinalIndex + 1) % cardinalPatterns.length;
    const pattern = cardinalPatterns[cardinalIndex];
    for (const key of Object.keys(muscles)) {
      const val = pattern.values[key] ?? 50;
      sliders[key].value = val.toString();
    }
    updateFromSliders();
    gazeReadout.textContent = pattern.name + " – " + gazeReadout.textContent;
  });

  // Attach slider listeners
  for (const key of Object.keys(muscles)) {
    sliders[key].addEventListener("input", updateFromSliders);
    sliders[key].addEventListener("change", updateFromSliders);
  }

  // Initial render
  updateFromSliders();
</script>
</body>
</html>
