<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fangman: Bite-to-Brain — Image Renderer</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rubik:wght@400;600;700;800&display=swap');
  :root{
    --bg:#0b0a0f; --panel:#13111b; --accent:#ff4d5e; --text:#eef2f7; --muted:#98a1b5;
    --btn:#1d1420; --btn-border:#4a1b28; --btn-grad1:#3a1320; --btn-grad2:#26101a; --right:#9be07a;
    --glow-green: rgba(160,255,140,.95);
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:'Rubik', ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--text);
       background: radial-gradient(1200px 600px at 15% -10%, #2a0f1a, var(--bg) 50%); min-height:100vh; display:flex; align-items:center; justify-content:center; overflow-x:hidden}
  .wrap{width:min(1180px,96vw); padding:18px}
  header{display:flex; align-items:center; justify-content:flex-start; gap:14px; margin-bottom:12px}
  .logo{height:92px; width:auto; display:block}
  .logo.right{height:64px; margin-left:10px; opacity:.95}
  @media (max-width:720px){
    .logo{height:64px}
    .logo.right{height:48px}
  }
  .board{display:grid; grid-template-columns:.55fr 1.45fr; gap:16px}
  .panel{background:linear-gradient(180deg, #171222 0, var(--panel) 100%); border:1px solid #2b2035; border-radius:12px; padding:14px;
         box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03)}
  .leftPanel{display:flex; align-items:flex-start; justify-content:flex-start}
  .rightPanel{min-height:460px; display:flex; flex-direction:column; justify-content:flex-start; gap:12px}
  .stageBox{ width:300px; height:440px; background:#0c0a12; border:1px solid #2e1a25; border-radius:10px;
             position:relative; overflow:hidden; display:block; }
  #stageImg{height:100%; width:auto; max-width:none; object-fit:contain; object-position:left center; display:block; background:transparent; border:none}
  .swarm{position:absolute; inset:0; pointer-events:none; overflow:hidden}
  .swarmGlobal{position:fixed; inset:0; pointer-events:none; overflow:visible; z-index:400}
  .assetWarn{position:absolute; bottom:10px; left:16px; background:#2a1420; color:#ffd1d7; border:1px solid #65293a; border-radius:8px; padding:8px 10px; font-size:12px; box-shadow:0 6px 16px rgba(0,0,0,.35); display:none}
  .word{display:flex; gap:12px; justify-content:center; align-items:center; padding:16px 8px 6px; flex-wrap:wrap; min-height:62px; margin-bottom:14px}
  .slot{width:38px; height:52px; border-bottom:3px solid #40305a; display:grid; place-items:center; font-weight:800; font-size:26px; letter-spacing:1px; color:var(--text)}
  .slot.revealed{color:var(--right); border-color:#456a3a}
  .kb{display:grid; grid-template-columns:repeat(13, minmax(44px,1fr)); gap:12px; margin-top:12px}
  .key{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--btn); border:1px solid var(--btn-border); border-radius:12px; padding:14px 0; text-align:center; cursor:pointer; user-select:none; font-weight:700; transition:.1s transform ease,.2s box-shadow ease}
  .key:hover{transform:translateY(-1px); box-shadow:0 0 0 1px rgba(255,77,94,.25), 0 6px 16px rgba(255,77,94,.08)}
  .key.used-wrong{background:#3a1320; color:#ff9aa6; border-color:#7a2b42; box-shadow:inset 0 0 0 1px rgba(255,77,94,.25)}
  .key.used-right{background:#163020; color:#b7f2a2; border-color:#2f6a41}
  .controls{display:flex; gap:12px; flex-wrap:wrap; margin-top:6px; justify-content:center}
  button{background:linear-gradient(180deg, var(--btn-grad1), var(--btn-grad2)); border:1px solid var(--btn-border); color:var(--text); font-weight:800; letter-spacing:.3px; padding:10px 16px; border-radius:12px; cursor:pointer; box-shadow:0 6px 16px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.03)}
  .modal{position:fixed; inset:0; display:none; place-items:center; backdrop-filter:blur(4px)}
  .modal.show{display:grid}
  .modal .card{width:min(560px,92vw); background:#171327; border:1px solid #2a1f39; border-radius:14px; padding:18px; box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .card h2{margin:0 0 6px; font-family:'Bebas Neue', ui-sans-serif, system-ui; letter-spacing:.6px}
  .card p{margin:6px 0 12px; color:var(--muted)}
  .card .big{font-size:20px; font-weight:800; margin-top:6px}
  .credits{margin-top:10px; text-align:right; font-size:12px; color:var(--muted); opacity:.85}
  @media (max-width:1100px){
    .wrap{width:min(1000px,96vw)}
    .board{grid-template-columns:1fr}
    .rightPanel{min-height:auto}
    .stageBox{width:260px; height:400px}
  }
  .bat { position: fixed; left: 50%; top: 50%; width: 56px; height: 32px;
         transform: translate(-50%, -50%) rotate(0deg); pointer-events: none; z-index: 1000;
         filter: drop-shadow(0 0 10px var(--glow-green)) drop-shadow(0 0 26px rgba(255,77,94,.45)); }
  .bat svg{ width:100%; height:100%; display:block; }
  .bat .aura{ position:absolute; inset:-18px;
    background: radial-gradient(50% 45% at 50% 50%, rgba(140,255,120,.9), rgba(120,220,90,.35) 50%, rgba(255,0,0,.18) 72%, transparent 76%);
    border-radius:50%; animation: batPulse 1.6s ease-in-out infinite; filter: blur(.6px); }
  @keyframes batPulse { 0%,100%{ transform:scale(.92); opacity:.95} 50%{ transform:scale(1.07); opacity:1 } }
  .virus { position:absolute; width:14px; height:14px; border-radius:50%;
    background: radial-gradient(circle at 35% 35%, #ffb3b3, #ff5555 55%, #c81424 75%);
    box-shadow: 0 0 8px rgba(255,80,80,.65), 0 0 18px rgba(255,60,80,.35);
    filter: saturate(1.2); pointer-events:none; }
  .virus::before, .virus::after{ content:''; position:absolute; inset:-4px; border-radius:50%;
    background: radial-gradient(circle, rgba(255,160,160,.25), transparent 70%); filter: blur(2px); }
  .virus::after{ inset:-8px; filter: blur(4px); opacity:.6}
  .field{margin:10px 0 4px}
  .optRow{display:flex; gap:14px; align-items:center; flex-wrap:wrap}
  .optRow label{display:flex; gap:8px; align-items:center; background:#171327; border:1px solid #2a1f39; padding:8px 12px; border-radius:10px; cursor:pointer}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="logo.png" alt="Fangman logo" class="logo" id="logoLeft" />
      <img src="logo-right.png" alt="Bite-to-Brain tagline" class="logo right" id="logoRight" />
    </header>

    <div class="board">
      <div class="panel leftPanel">
        <div class="stageBox" id="stageBox">
          <img id="stageImg" src="strike0.png" alt="infection progression"/>
          <div class="swarm" id="swarm"></div>
        </div>
        <div id="assetWarn" class="assetWarn"></div>
      </div>
      <div class="panel rightPanel">
        <div id="word" class="word" aria-live="polite"></div>
        <div id="keyboard" class="kb" role="group" aria-label="letter keyboard"></div>
        <div class="controls">
          <button id="newWord">New word</button>
          <button id="hintBtn" title="Show a clue (costs 1 turn)">Hint (−1 turn)</button>
          <button id="optionsBtn" title="Game options">Options</button>
        </div>
      </div>
    </div>
    <div class="credits">created by micah etter, md</div>
  </div>
  <div id="swarmGlobal" class="swarmGlobal"></div>

  <div id="bat" class="bat" aria-hidden="true">
    <div class="aura"></div>
    <svg viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <style>
          .wingL, .wingR { transform-origin: 100px 60px; }
          .wingL { animation: flapL .35s ease-in-out infinite alternate; }
          .wingR { animation: flapR .35s ease-in-out infinite alternate; }
          @keyframes flapL { from{ transform: rotate(14deg)} to{ transform: rotate(-18deg)} }
          @keyframes flapR { from{ transform: rotate(-14deg)} to{ transform: rotate(18deg)} }
        </style>
      </defs>
      <ellipse cx="100" cy="60" rx="22" ry="16" fill="#0f0f12"/>
      <circle cx="106" cy="60" r="7" fill="#0b0b0d"/>
      <circle cx="103" cy="58" r="2.8" fill="#aaff88"/>
      <circle cx="113" cy="58" r="2.8" fill="#aaff88"/>
      <g class="wingL">
        <path d="M100,60 C70,35 35,35 10,55 C35,55 60,65 85,80" fill="#13131a" stroke="#0e0e13" stroke-width="3"/>
      </g>
      <g class="wingR">
        <path d="M100,60 C130,35 165,35 190,55 C165,55 140,65 115,80" fill="#13131a" stroke="#0e0e13" stroke-width="3"/>
      </g>
    </svg>
  </div>

  <div class="modal" id="modal">
    <div class="card">
      <h2 id="modalTitle">Containment Success</h2>
      <div class="big" id="modalWord"></div>
      <p id="modalMsg">Encephalitis averted — the viral ascent was blocked in time.</p>
      <div class="controls">
        <button id="playAgain">Play again</button>
        <button id="closeModal">Close</button>
      </div>
    </div>
  </div>

  <div class="modal" id="hintModal">
    <div class="card">
      <h2>Hint</h2>
      <p id="hintText">A clue appears here.</p>
      <div class="controls">
        <button id="confirmHint">OK</button>
      </div>
    </div>
  </div>

  <div class="modal" id="optionsModal">
    <div class="card">
      <h2>Options</h2>
      <div class="field">
        <div class="subtitle" style="margin-bottom:6px">Word pack</div>
        <div class="optRow">
          <label><input type="radio" name="packSel" value="neuroinfectious"> Neuroinfectious only</label>
          <label><input type="radio" name="packSel" value="general"> All neurology</label>
        </div>
        <div class="subtitle" style="margin-top:8px; font-size:12px">
          (Later we'll point this to an external CSV.)
        </div>
      </div>
      <div class="controls">
        <button id="saveOptions">Apply</button>
        <button id="closeOptions">Close</button>
      </div>
    </div>
  </div>

<script>
(()=>{
  const IMAGE_CONFIG = { base:'./', prefix:'strike', ext:'png', count:10 };
  const STRIKE_IMAGES = Array.from({length: IMAGE_CONFIG.count}, (_,i) => `${IMAGE_CONFIG.base}${IMAGE_CONFIG.prefix}${i}.${IMAGE_CONFIG.ext}`);
  const MAX_STRIKES = STRIKE_IMAGES.length - 1;

  const UI = {
    stageImg: document.getElementById('stageImg'),
    stageBox: document.getElementById('stageBox'),
    swarm: document.getElementById('swarm'),
    swarmGlobal: document.getElementById('swarmGlobal'),
    assetWarn: document.getElementById('assetWarn'),
    wordEl: document.getElementById('word'),
    kb: document.getElementById('keyboard'),
    newWord: document.getElementById('newWord'),
    modal: document.getElementById('modal'),
    modalTitle: document.getElementById('modalTitle'),
    modalMsg: document.getElementById('modalMsg'),
    modalWord: document.getElementById('modalWord'),
    playAgain: document.getElementById('playAgain'),
    closeModal: document.getElementById('closeModal'),
    hintBtn: document.getElementById('hintBtn'),
    hintModal: document.getElementById('hintModal'),
    hintText: document.getElementById('hintText'),
    confirmHint: document.getElementById('confirmHint'),
    optionsBtn: document.getElementById('optionsBtn'),
    optionsModal: document.getElementById('optionsModal'),
    closeOptions: document.getElementById('closeOptions'),
    saveOptions: document.getElementById('saveOptions'),
    bat: document.getElementById('bat')
  };

  // Packs / hints
  const PACKS = {
    neuroinfectious: { name: 'Neuroinfectious', words: ['RABIES','MENINGITIS','ENCEPHALITIS','NEUROCYSTICERCOSIS','BRAINABSCESS'] },
    general: { name: 'All Neurology', words: ['CEREBELLUM','THALAMUS','PARKINSONISM','EPILEPSY','MYASTHENIA'] }
  };
  const HINTS = {
    'RABIES':'Lyssavirus infection ascending from peripheral bite to CNS.',
    'MENINGITIS':'Inflammation of meninges; fever, neck stiffness, AMS.',
    'ENCEPHALITIS':'Inflammation of brain parenchyma—often viral (HSV).',
    'NEUROCYSTICERCOSIS':'Taenia solium larvae in CNS; seizures, ring lesions.',
    'BRAINABSCESS':'Focal intracranial infection with ring-enhancing mass.',
    'CEREBELLUM':'Coordinates movement and balance.',
    'THALAMUS':'Relay for sensory and motor signals to cortex.',
    'PARKINSONISM':'Bradykinesia ± tremor/rigidity due to dopamine loss.',
    'EPILEPSY':'Tendency to have unprovoked seizures.',
    'MYASTHENIA':'Autoimmune NMJ disorder with fatigable weakness.'
  };
  function genericClue(word){
    const w = word.toUpperCase();
    if(/RABIES|MENING|ENCEPHAL|ABSCESS|CYSTICER/.test(w)) return 'Neuroinfectious disease.';
    if(/FRONTAL|PARIETAL|TEMPORAL|OCCIPITAL|CORTEX|CEREBELL|THALAM/.test(w)) return 'Anatomy — cortical or relay structure.';
    if(/EPILEP|MYASTHEN|PARKINSON/.test(w)) return 'Neurology condition or disorder.';
    return 'Neurology term — think anatomy, physiology, or pathology.';
  }

  // Persisted pack:
  let currentPackKey = (localStorage.getItem('fangman_pack') || 'neuroinfectious');
  if(!PACKS[currentPackKey]) currentPackKey = 'neuroinfectious';

  // Game state
  const STATE = { pack: PACKS[currentPackKey], word: '', letters: new Set(), wrong: new Set(), won:false, lost:false, hintUsed:false };

  // ---- Virus swarm modes ----
  let swarmMode = 'cursor'; // 'cursor' or 'image'
  let cursorLocal = {x: 150, y: 220}; // within stageBox overlay
  let cursorGlobal = {x: window.innerWidth*0.6, y: window.innerHeight*0.5};
  let redTargets = [];
  let viruses = [];
  let animHandle = null;

  function switchSwarmMode(mode){
    swarmMode = mode;
    // move existing particles to correct container
    const parent = (mode==='cursor') ? UI.swarmGlobal : UI.swarm;
    viruses.forEach(v => { if(v.el.parentNode!==parent){ parent.appendChild(v.el); }});
  }

  function updateStageImage(){
    const idx = Math.min(STATE.wrong.size, MAX_STRIKES);
    const want = STRIKE_IMAGES[idx];
    UI.stageImg.onload = () => { analyzeRedTargets(); syncRightPanelHeight(); };
    UI.stageImg.src = want;
    UI.stageImg.alt = `Strike ${idx}`;
  }

  function syncRightPanelHeight(){
    try{
      const stage = UI.stageBox;
      const right = document.querySelector('.rightPanel');
      if(stage && right){
        right.style.minHeight = stage.clientHeight + 'px';
        right.style.height = stage.clientHeight + 'px';
      }
    }catch(e){}
  }

  function renderWord(){
    UI.wordEl.innerHTML='';
    for(const ch of STATE.word){
      const div=document.createElement('div');
      div.className='slot'+(STATE.letters.has(ch)?' revealed':'');
      div.textContent=STATE.letters.has(ch)?ch:'';
      div.setAttribute('aria-label',STATE.letters.has(ch)?ch:'blank');
      UI.wordEl.appendChild(div);
    }
  }
  function renderKeyboard(){
    const alpha='ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    UI.kb.innerHTML='';
    alpha.forEach(l=>{
      const k=document.createElement('div');
      k.className='key'; k.textContent=l; k.onclick=()=>guess(l);
      if(STATE.letters.has(l)){ k.classList.add('used-right'); k.style.pointerEvents='none'; }
      if(STATE.wrong.has(l)){ k.classList.add('used-wrong'); k.style.pointerEvents='none'; }
      UI.kb.appendChild(k);
    });
  }
  function randWord(){ const arr=STATE.pack.words; return arr[Math.floor(Math.random()*arr.length)].toUpperCase().replace(/[^A-Z]/g,''); }
  function reset(word=null){
    STATE.word=(word||randWord()); STATE.letters=new Set(); STATE.wrong=new Set();
    STATE.won=false; STATE.lost=false; STATE.hintUsed=false;
    switchSwarmMode('cursor');
    renderWord(); renderKeyboard(); updateStageImage(); rebuildSwarm(); syncRightPanelHeight();
  }
  function guess(ch){
    if(STATE.won||STATE.lost) return; ch=ch.toUpperCase(); if(!/^[A-Z]$/.test(ch)) return;
    if(STATE.word.includes(ch)){ STATE.letters.add(ch); }
    else if(!STATE.wrong.has(ch)) {
      const prev = STATE.wrong.size;
      STATE.wrong.add(ch);
      if(prev===0){ swarmMode = 'image'; analyzeRedTargets(); }
      updateStageImage();
    }
    renderWord(); renderKeyboard(); checkState();
  }
  function checkState(){
    const uniq=new Set(STATE.word.split('')); let all=true; for(const l of uniq){ if(!STATE.letters.has(l)){ all=false; break; } }
    if(all){ STATE.won=true; showModal(true); return; }
    if(STATE.wrong.size>=MAX_STRIKES){ STATE.lost=true; showModal(false); }
  }
  function useHint(){
    if(STATE.won||STATE.lost) return;
    const word = STATE.word;
    const clue = HINTS[word] || genericClue(word);
    if(!STATE.hintUsed){ STATE.hintUsed = true; STATE.wrong.add('HINT'); if(swarmMode==='cursor'){ switchSwarmMode('image'); } updateStageImage(); }
    UI.hintText.textContent = clue; UI.hintModal.classList.add('show');
  }
  function showModal(win){
    UI.modalTitle.textContent = win? 'Containment Success' : 'Containment Failed';
    UI.modalMsg.textContent = win? 'Encephalitis averted — the viral ascent was blocked in time.' : 'Rabies has consumed the central nervous system.';
    UI.modalWord.textContent = STATE.word; UI.modal.classList.add('show');
  }
  function hideModal(){ UI.modal.classList.remove('show'); }

  // Keyboard + buttons
  window.addEventListener('keydown', (e)=>{ if(e.key && e.key.length===1){ guess(e.key.toUpperCase()); } else if(e.key==='Enter' && (STATE.won||STATE.lost)){ hideModal(); reset(); } });
  UI.newWord.onclick = ()=> reset();
  UI.playAgain.onclick = ()=>{ hideModal(); reset(); };
  UI.closeModal.onclick = ()=> hideModal();
  UI.hintBtn.onclick = ()=> useHint();

  // Options (no duplicate consts now)
  UI.optionsBtn.onclick = ()=> {
    const radios = document.querySelectorAll('input[name="packSel"]');
    radios.forEach(r => r.checked = (r.value===currentPackKey));
    UI.optionsModal.classList.add('show');
  };
  UI.closeOptions.onclick = ()=> UI.optionsModal.classList.remove('show');
  UI.saveOptions.onclick = ()=>{
    const sel = document.querySelector('input[name="packSel"]:checked');
    if(sel && PACKS[sel.value]){
      currentPackKey = sel.value;
      localStorage.setItem('fangman_pack', currentPackKey);
      STATE.pack = PACKS[currentPackKey];
      reset();
    }
    UI.optionsModal.classList.remove('show');
  };
  UI.confirmHint.onclick = ()=> UI.hintModal.classList.remove('show');

  // Bat follower + cursor pos for viruses
  (function initBat(){
    const bat = UI.bat; if(!bat) return;
    let targetX = window.innerWidth  * 0.7;
    let targetY = window.innerHeight * 0.4;
    let x = targetX, y = targetY, lastX = x, lastY = y;
    let firstMove = true;
    function updateCursorLocalFromClient(clientX, clientY){
      const rect = UI.stageBox.getBoundingClientRect();
      cursorLocal.x = Math.max(0, Math.min(rect.width, clientX - rect.left));
      cursorLocal.y = Math.max(0, Math.min(rect.height, clientY - rect.top));
    }
    function onMove(clientX, clientY){
      targetX = clientX; targetY = clientY;
      cursorGlobal.x = clientX; cursorGlobal.y = clientY;
      updateCursorLocalFromClient(clientX, clientY);
      if(firstMove){ x = clientX; y = clientY; firstMove = false; }
    }
    window.addEventListener('mousemove', (e)=> onMove(e.clientX, e.clientY), {passive:true});
    window.addEventListener('touchmove', (e)=>{ if(e.touches && e.touches.length){ const t=e.touches[0]; onMove(t.clientX, t.clientY);} }, {passive:true});
    function tick(){
      const dx = targetX - x, dy = targetY - y;
      const ease = 0.38 + Math.min(0.22, Math.hypot(dx,dy)/600);
      x += dx * ease; y += dy * ease;
      const angle = Math.atan2(y-lastY, x-lastX) * 180/Math.PI;
      bat.style.left = x + 'px'; bat.style.top = y + 'px';
      bat.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
      lastX = x; lastY = y;
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  })();

  // Virus swarm
  function analyzeRedTargets(){
    try{
      const img = UI.stageImg;
      const w = img.naturalWidth, h = img.naturalHeight;
      if(!w || !h) return;
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      const ctx = c.getContext('2d');
      ctx.drawImage(img, 0, 0);
      const data = ctx.getImageData(0,0,w,h).data;
      const pts = [];
      const step = 8;
      for(let y=0;y<h;y+=step){
        for(let x=0;x<w;x+=step){
          const i = (y*w + x) * 4;
          const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
          if(a>80 && r>160 && r>g*1.5 && r>b*1.5){
            pts.push({x, y});
          }
        }
      }
      const scaleX = UI.stageImg.clientWidth  / w;
      const scaleY = UI.stageImg.clientHeight / h;
      redTargets = pts.map(p => ({ x: p.x*scaleX, y: p.y*scaleY }));
      rebuildSwarm();
    }catch(e){
      redTargets = [];
      rebuildSwarm();
    }
  }

  function rebuildSwarm(){
    const base = 8;
    const extra = Math.min(30, STATE.wrong.size * 5);
    const need = base + extra;
    const have = viruses.length;
    for(let i=need;i<have;i++){
      const v = viruses.pop(); v.el.remove();
    }
    const parent = (swarmMode==='cursor') ? UI.swarmGlobal : UI.swarm;
    for(let i=have;i<need;i++){
      const el = document.createElement('div');
      el.className = 'virus';
      parent.appendChild(el);
      let spawnX, spawnY;
      if(swarmMode==='cursor'){
        // spawn very close to bat
        spawnX = cursorGlobal.x + (Math.random()-0.5)*12;
        spawnY = cursorGlobal.y + (Math.random()-0.5)*12;
      } else {
        spawnX = Math.random()*UI.stageImg.clientWidth; 
        spawnY = Math.random()*UI.stageImg.clientHeight;
      }
      viruses.push({ el, x: spawnX, y: spawnY, vx:0, vy:0, target: null, t:0 });
    }
    if(!animHandle){ animateSwarm(); }
  }

  function pickTarget(){
    if(swarmMode === 'cursor'){
      const r = 8; // very tight orbit around bat/mouse
      return { x: cursorGlobal.x + (Math.random()-0.5)*r, y: cursorGlobal.y + (Math.random()-0.5)*r };
    }
    if(redTargets.length) return redTargets[Math.floor(Math.random()*redTargets.length)];
    return { x: Math.random()*UI.stageImg.clientWidth*0.6 + 10, y: UI.stageImg.clientHeight*0.85 + Math.random()*20 - 10 };
  }

  function animateSwarm(){
    const w = (swarmMode==='cursor'? window.innerWidth : UI.stageImg.clientWidth);
    const h = (swarmMode==='cursor'? window.innerHeight: UI.stageImg.clientHeight);
    const parent = (swarmMode==='cursor') ? UI.swarmGlobal : UI.swarm;
    // Ensure parent is correct in case of resize or mode switch
    viruses.forEach(v => { if(v.el.parentNode!==parent){ parent.appendChild(v.el); }});
    viruses.forEach(v => {
      if(!v.target || Math.random()<0.01){ v.target = pickTarget(); }
      const followK = (swarmMode==='cursor') ? 0.06 : 0.02; // stronger pull to the bat
      const jitter = (swarmMode==='cursor') ? 0.05 : 0.15;   // less random drift near the bat
      const ax = (v.target.x - v.x) * followK;
      const ay = (v.target.y - v.y) * followK;
      v.vx += ax + (Math.random()-.5)*jitter;
      v.vy += ay + (Math.random()-.5)*jitter;
      v.vx *= 0.92; v.vy *= 0.92;
      v.x += v.vx; v.y += v.vy;
      v.x = Math.max(6, Math.min(w-6, v.x));
      v.y = Math.max(6, Math.min(h-6, v.y));
      v.el.style.transform = `translate(${v.x-7}px, ${v.y-7}px)`;
    });
    animHandle = requestAnimationFrame(animateSwarm);
  }

  function preloadImages(){ return Promise.all(STRIKE_IMAGES.map((url,i)=>new Promise(res=>{ const img=new Image(); img.onload=()=>res(true); img.onerror=()=>res(false); img.src=url; }))); }
  preloadImages().then(()=>{ reset(); });
  window.addEventListener('resize', ()=>{ analyzeRedTargets(); syncRightPanelHeight(); });

  window._fangmanReset = reset;
})();
</script>
</body>
</html>
